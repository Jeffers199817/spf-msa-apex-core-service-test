<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GlobalExceptionHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">spf-msa-apex-core-service</a> &gt; <a href="index.source.html" class="el_package">com.pichincha.spfmsaapexcoreservice.exception</a> &gt; <span class="el_source">GlobalExceptionHandler.java</span></div><h1>GlobalExceptionHandler.java</h1><pre class="source lang-java linenums">package com.pichincha.spfmsaapexcoreservice.exception;

import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.Map;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
<span class="fc" id="L14">public class GlobalExceptionHandler {</span>

  // 1. Manejar ResourceNotFoundException → 404 Not Found
  @ExceptionHandler(ResourceNotFoundException.class)
  public ResponseEntity&lt;ErrorResponse&gt; handleResourceNotFoundException(
    ResourceNotFoundException ex
  ) {
<span class="nc" id="L21">    ErrorResponse errorResponse = ErrorResponse.builder()</span>
<span class="nc" id="L22">      .timestamp(LocalDateTime.now())</span>
<span class="nc" id="L23">      .status(HttpStatus.NOT_FOUND.value())</span>
<span class="nc" id="L24">      .error(HttpStatus.NOT_FOUND.getReasonPhrase())</span>
<span class="nc" id="L25">      .message(ex.getMessage())</span>
<span class="nc" id="L26">      .build();</span>
<span class="nc" id="L27">    return new ResponseEntity&lt;&gt;(errorResponse, HttpStatus.NOT_FOUND);</span>
  }

  // 2. Manejar InsufficientBalanceException → 400 Bad Request
  @ExceptionHandler(InsufficientBalanceException.class)
  public ResponseEntity&lt;ErrorResponse&gt; handleInsufficientBalanceException(
    InsufficientBalanceException ex
  ) {
<span class="fc" id="L35">    ErrorResponse errorResponse = ErrorResponse.builder()</span>
<span class="fc" id="L36">      .timestamp(LocalDateTime.now())</span>
<span class="fc" id="L37">      .status(HttpStatus.BAD_REQUEST.value())</span>
<span class="fc" id="L38">      .error(HttpStatus.BAD_REQUEST.getReasonPhrase())</span>
<span class="fc" id="L39">      .message(ex.getMessage())</span>
<span class="fc" id="L40">      .build();</span>
<span class="fc" id="L41">    return new ResponseEntity&lt;&gt;(errorResponse, HttpStatus.BAD_REQUEST);</span>
  }

  // 3. Manejar errores de validación → 400 Bad Request
  @ExceptionHandler(MethodArgumentNotValidException.class)
  public ResponseEntity&lt;ErrorResponse&gt; handleValidationExceptions(
    MethodArgumentNotValidException ex
  ) {
<span class="nc" id="L49">    Map&lt;String, String&gt; errors = new HashMap&lt;&gt;();</span>
<span class="nc" id="L50">    ex.getBindingResult().getAllErrors().forEach(error -&gt; {</span>
<span class="nc" id="L51">      String fieldName = ((FieldError) error).getField();</span>
<span class="nc" id="L52">      String errorMessage = error.getDefaultMessage();</span>
<span class="nc" id="L53">      errors.put(fieldName, errorMessage);</span>
<span class="nc" id="L54">    });</span>

<span class="nc" id="L56">    ErrorResponse errorResponse = ErrorResponse.builder()</span>
<span class="nc" id="L57">      .timestamp(LocalDateTime.now())</span>
<span class="nc" id="L58">      .status(HttpStatus.BAD_REQUEST.value())</span>
<span class="nc" id="L59">      .error(HttpStatus.BAD_REQUEST.getReasonPhrase())</span>
<span class="nc" id="L60">      .message(&quot;Validation failed&quot;)</span>
<span class="nc" id="L61">      .errors(errors)</span>
<span class="nc" id="L62">      .build();</span>
<span class="nc" id="L63">    return new ResponseEntity&lt;&gt;(errorResponse, HttpStatus.BAD_REQUEST);</span>
  }

  // 4. Manejar IllegalArgumentException → 400 Bad Request
  @ExceptionHandler(IllegalArgumentException.class)
  public ResponseEntity&lt;ErrorResponse&gt; handleIllegalArgumentException(
    IllegalArgumentException ex
  ) {
<span class="nc" id="L71">    ErrorResponse errorResponse = ErrorResponse.builder()</span>
<span class="nc" id="L72">      .timestamp(LocalDateTime.now())</span>
<span class="nc" id="L73">      .status(HttpStatus.BAD_REQUEST.value())</span>
<span class="nc" id="L74">      .error(HttpStatus.BAD_REQUEST.getReasonPhrase())</span>
<span class="nc" id="L75">      .message(ex.getMessage())</span>
<span class="nc" id="L76">      .build();</span>
<span class="nc" id="L77">    return new ResponseEntity&lt;&gt;(errorResponse, HttpStatus.BAD_REQUEST);</span>
  }

  // 5. Manejar TODAS las demás excepciones no capturadas → 500 Internal Server Error
  @ExceptionHandler(Exception.class)
  public ResponseEntity&lt;ErrorResponse&gt; handleGlobalException(Exception ex) {
    // Log del error para debugging
<span class="nc" id="L84">    ex.printStackTrace();</span>
    
<span class="nc" id="L86">    ErrorResponse errorResponse = ErrorResponse.builder()</span>
<span class="nc" id="L87">      .timestamp(LocalDateTime.now())</span>
<span class="nc" id="L88">      .status(HttpStatus.INTERNAL_SERVER_ERROR.value())</span>
<span class="nc" id="L89">      .error(HttpStatus.INTERNAL_SERVER_ERROR.getReasonPhrase())</span>
<span class="nc" id="L90">      .message(&quot;Error interno del servidor: &quot; + ex.getMessage())</span>
<span class="nc" id="L91">      .build();</span>
<span class="nc" id="L92">    return new ResponseEntity&lt;&gt;(errorResponse, HttpStatus.INTERNAL_SERVER_ERROR);</span>
  }

<span class="fc" id="L95">  public static class ErrorResponse {</span>
    private LocalDateTime timestamp;
    private Integer status;
    private String error;
    private String message;
    private Map&lt;String, String&gt; errors;

    public static ErrorResponseBuilder builder() {
<span class="fc" id="L103">      return new ErrorResponseBuilder();</span>
    }

    public LocalDateTime getTimestamp() {
<span class="fc" id="L107">      return timestamp;</span>
    }

    public void setTimestamp(LocalDateTime timestamp) {
<span class="nc" id="L111">      this.timestamp = timestamp;</span>
<span class="nc" id="L112">    }</span>

    public Integer getStatus() {
<span class="fc" id="L115">      return status;</span>
    }

    public void setStatus(Integer status) {
<span class="nc" id="L119">      this.status = status;</span>
<span class="nc" id="L120">    }</span>

    public String getError() {
<span class="fc" id="L123">      return error;</span>
    }

    public void setError(String error) {
<span class="nc" id="L127">      this.error = error;</span>
<span class="nc" id="L128">    }</span>

    public String getMessage() {
<span class="fc" id="L131">      return message;</span>
    }

    public void setMessage(String message) {
<span class="nc" id="L135">      this.message = message;</span>
<span class="nc" id="L136">    }</span>

    public Map&lt;String, String&gt; getErrors() {
<span class="fc" id="L139">      return errors;</span>
    }

    public void setErrors(Map&lt;String, String&gt; errors) {
<span class="nc" id="L143">      this.errors = errors;</span>
<span class="nc" id="L144">    }</span>

<span class="fc" id="L146">    public static class ErrorResponseBuilder {</span>
      private LocalDateTime timestamp;
      private Integer status;
      private String error;
      private String message;
      private Map&lt;String, String&gt; errors;

      public ErrorResponseBuilder timestamp(LocalDateTime timestamp) {
<span class="fc" id="L154">        this.timestamp = timestamp;</span>
<span class="fc" id="L155">        return this;</span>
      }

      public ErrorResponseBuilder status(Integer status) {
<span class="fc" id="L159">        this.status = status;</span>
<span class="fc" id="L160">        return this;</span>
      }

      public ErrorResponseBuilder error(String error) {
<span class="fc" id="L164">        this.error = error;</span>
<span class="fc" id="L165">        return this;</span>
      }

      public ErrorResponseBuilder message(String message) {
<span class="fc" id="L169">        this.message = message;</span>
<span class="fc" id="L170">        return this;</span>
      }

      public ErrorResponseBuilder errors(Map&lt;String, String&gt; errors) {
<span class="nc" id="L174">        this.errors = errors;</span>
<span class="nc" id="L175">        return this;</span>
      }

      public ErrorResponse build() {
<span class="fc" id="L179">        ErrorResponse response = new ErrorResponse();</span>
<span class="fc" id="L180">        response.timestamp = this.timestamp;</span>
<span class="fc" id="L181">        response.status = this.status;</span>
<span class="fc" id="L182">        response.error = this.error;</span>
<span class="fc" id="L183">        response.message = this.message;</span>
<span class="fc" id="L184">        response.errors = this.errors;</span>
<span class="fc" id="L185">        return response;</span>
      }
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>